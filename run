#!/usr/bin/sh

show_help () {
	echo wastat toolkit v0.1, by phikal
	echo
	echo usage:
	echo "	word-count, wc:"
	echo "		count word occurances"
	echo "		default chat file: chat.txt or 2nd argument"
	echo "		default output: words.lis or 3rd argument"
	echo "	word-output, wo:"
	echo "		output all words separately"
	echo "		default chat file: chat.txt or 2nd argument"
	echo "		default output: words.txt or 3rd argument"
	echo "	plot-dates, pd:"
	echo "		plot all dates"
	echo "		default chat file: chat.txt or 2nd argument"
	echo "		the first and last date automatically extracted"
	echo "		can be manaully set as 3rd and 4th argument"
	echo "	help, -h:"
	echo "		this message"
}

show_error () {
	echo invalid command
	show_help
}

plot_dates () {
	if ! type gnuplot > /dev/null; then
		echo "gnuplot is needed to plot the data"
		exit 1
	fi	

	INPUT=${1:-chat.txt}

	FIRST=$(head -1 $INPUT | sed 's/,.*$//')
	LAST=$(tail -1 $INPUT | sed 's/,.*$//')

	START=${2:-$FIRST}
	END=${3:-$LAST}

	echo "Using $INPUT to plot message count over time from $START to $END"
	./wastat date $INPUT | ./lis | ./fmd $START $END > date.dat
	echo "Finished extraction, opening gnuplot..."
	gnuplot -p all.gp
}

word_count () {
	INPUT=${1:-chat.txt}
	OUTPUT=${2:-words.lis}

	echo "Using $INPUT to count words and save result into $OUTPUT"
	# extract message | extract words | to upper to lower case | count | sort numerically
	./wastat m $INPUT | grep -E -o "\w+" | tr [:upper:] [:lower:] | ./lis | sort -nr > $OUTPUT
	echo "Finished word count with $(cat $OUTPUT | wc -l) different words."
}

word_output () {
	INPUT=${1:-chat.txt}
	OUTPUT=${2:-words.txt}

	echo "Using $INPUT to extract words into $OUTPUT"
	# extract message | extract words | to upper to lower case
	./wastat m $INPUT | grep -E -o "\w+" | tr [:upper:] [:lower:] > $OUTPUT
	echo "Finished word output with $(cat $OUTPUT | wc -l) words."
}

case "$1" in
	word-count|wc) shift; 	word_count "$@";;
	word-output|wo) shift; 	word_output "$@";;
	plot-dates|pd) shift; 	plot_dates "$@";;
	help|-h) shift; 	show_help "$@";;
	*) shift; 		show_error "$@";;
esac
exit 0
